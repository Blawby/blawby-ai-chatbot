name: Deploy Frontend and Backend

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]  # Trigger on version tags
  pull_request:
    types: [opened, synchronize, reopened, closed]
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup, install, build, and install Wrangler
      uses: ./.github/actions/setup-and-build
      with:
        node-version: '20'
        run-build: 'true'
        install-wrangler: 'true'
      
    - name: Set version info
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION="dev-${GITHUB_SHA:0:8}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "deploy_timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
        echo "Deploying version: $VERSION"

    - name: Type check
      run: npm run type-check || echo "TypeScript check skipped (no type-check script)"

    - name: Build frontend (redundant safeguard)
      run: npm run build

    - name: Apply D1 migrations (production)
      run: |
        echo "Applying D1 migrations to production..."
        wrangler d1 migrations apply blawby-ai-chatbot --remote
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    - name: Deploy backend to Cloudflare Workers
      run: |
        echo "Deploying version ${{ steps.version.outputs.version }} at ${{ steps.version.outputs.deploy_timestamp }}"
        wrangler deploy --env production --var VERSION=${{ steps.version.outputs.version }} --var DEPLOY_TIMESTAMP=${{ steps.version.outputs.deploy_timestamp }}
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        
    - name: Rollback on failure
      if: failure()
      run: |
        echo "Deployment failed, attempting rollback..."
        # Store current deployment info for potential rollback
        echo "Failed deployment version: ${{ steps.version.outputs.version }}"
        echo "Failed deployment timestamp: ${{ steps.version.outputs.deploy_timestamp }}"
        # Note: Actual rollback would require storing previous deployment artifacts
        # For now, we'll just log the failure for manual intervention
        echo "Manual rollback may be required. Check Cloudflare dashboard."

    # Organizations are managed via the API â€” see ORGANIZATION_API_MIGRATION.md for usage

    - name: Deploy frontend to Cloudflare Pages
      uses: cloudflare/pages-action@v1
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        projectName: ${{ secrets.CLOUDFLARE_PAGES_PROJECT_NAME }}
        directory: dist
        gitHubToken: ${{ secrets.GITHUB_TOKEN }}

  preview:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup, install, build, and install Wrangler
      uses: ./.github/actions/setup-and-build
      with:
        node-version: '20'
        run-build: 'true'
        install-wrangler: 'false'

    - name: Deploy preview Pages
      if: github.event.action != 'closed'
      uses: cloudflare/pages-action@v1
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        projectName: ${{ secrets.CLOUDFLARE_PAGES_PROJECT_NAME }}
        directory: dist
        gitHubToken: ${{ secrets.GITHUB_TOKEN }}
        # This enables preview deployments for PRs
        branch: ${{ github.head_ref }} 
