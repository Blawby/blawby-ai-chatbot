name: Deploy to Cloudflare

on:
  push:
    branches:
      - main
      - staging
  workflow_dispatch:

jobs:
  deploy-worker:
    name: Deploy Cloudflare Worker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve deploy env
        run: |
          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            echo "DEPLOY_ENV=production" >> "$GITHUB_ENV"
          else
            echo "DEPLOY_ENV=staging" >> "$GITHUB_ENV"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Debug - versions
        run: |
          node -v
          npm -v
          npx --version

      - name: Debug - list worker files
        run: |
          pwd
          ls -la
          ls -la worker || true
          ls -la worker/wrangler.toml || true

      - name: Debug - show wrangler config
        run: |
          cat worker/wrangler.toml || true

      - name: Validate deployment secrets
        run: |
          if [[ -z "${CLOUDFLARE_API_TOKEN:-}" ]]; then
            echo "âŒ CLOUDFLARE_API_TOKEN is not set" >&2
            exit 1
          fi
          if [[ -z "${CLOUDFLARE_ACCOUNT_ID:-}" ]]; then
            echo "âŒ CLOUDFLARE_ACCOUNT_ID is not set" >&2
            exit 1
          fi
          echo "âœ… Deployment secrets are set"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy Worker (direct wrangler)
        env:
          WRANGLER_LOG: debug
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          set -euxo pipefail
          npx wrangler --version
          npx wrangler deploy --env "${DEPLOY_ENV}" --config worker/wrangler.toml

      - name: Check wrangler logs
        if: always()
        run: |
          echo "ðŸ“‹ Wrangler logs:"
          ls -la ~/.config/.wrangler/logs 2>/dev/null || true
          ls -la ~/.wrangler/logs 2>/dev/null || true
          LATEST_LOG="$(ls -t ~/.config/.wrangler/logs/wrangler-*.log ~/.wrangler/logs/wrangler-*.log 2>/dev/null | head -1)"
          if [[ -n "$LATEST_LOG" ]]; then
            echo "Showing latest log: $LATEST_LOG"
            tail -300 "$LATEST_LOG"
          else
            echo "No wrangler logs found"
          fi

      - name: Deployment summary
        if: success()
        run: echo "âœ… Worker deployed successfully to production"

      - name: Deployment failed
        if: failure()
        run: |
          echo "âŒ Worker deployment failed"
          exit 1

  deploy-frontend:
    name: Deploy Cloudflare Pages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve build env
        run: |
          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            echo "DEPLOY_ENV=production" >> "$GITHUB_ENV"
            echo "PAGES_PROJECT=blawby-ai-chatbot-frontend" >> "$GITHUB_ENV"
            {
              echo "VITE_BACKEND_API_URL<<EOF"
              echo "$VITE_BACKEND_API_URL_PROD"
              echo "EOF"
              echo "VITE_APP_BASE_URL<<EOF"
              echo "$VITE_APP_BASE_URL_PROD"
              echo "EOF"
              echo "VITE_WORKER_API_URL<<EOF"
              echo "$VITE_WORKER_API_URL_PROD"
              echo "EOF"
            } >> "$GITHUB_ENV"
          else
            echo "DEPLOY_ENV=staging" >> "$GITHUB_ENV"
            echo "PAGES_PROJECT=blawby-ai-chatbot-frontend-staging" >> "$GITHUB_ENV"
            {
              echo "VITE_BACKEND_API_URL<<EOF"
              echo "$VITE_BACKEND_API_URL_STG"
              echo "EOF"
              echo "VITE_APP_BASE_URL<<EOF"
              echo "$VITE_APP_BASE_URL_STG"
              echo "EOF"
              echo "VITE_WORKER_API_URL<<EOF"
              echo "$VITE_WORKER_API_URL_STG"
              echo "EOF"
            } >> "$GITHUB_ENV"
          fi
        env:
          VITE_BACKEND_API_URL_PROD: ${{ secrets.VITE_BACKEND_API_URL }}
          VITE_APP_BASE_URL_PROD: ${{ secrets.VITE_APP_BASE_URL }}
          VITE_WORKER_API_URL_PROD: ${{ secrets.VITE_WORKER_API_URL }}
          VITE_BACKEND_API_URL_STG: ${{ secrets.VITE_BACKEND_API_URL_STAGING }}
          VITE_APP_BASE_URL_STG: ${{ secrets.VITE_APP_BASE_URL_STAGING }}
          VITE_WORKER_API_URL_STG: ${{ secrets.VITE_WORKER_API_URL_STAGING }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate build env
        run: |
          if [[ -z "${VITE_BACKEND_API_URL:-}" ]]; then
            echo "VITE_BACKEND_API_URL is required for build." >&2
            exit 1
          fi
          if [[ -z "${VITE_APP_BASE_URL:-}" ]]; then
            echo "VITE_APP_BASE_URL is required for SSR/build contexts." >&2
            exit 1
          fi
          if [[ -z "${VITE_WORKER_API_URL:-}" ]]; then
            echo "VITE_WORKER_API_URL is required for SSR/build contexts." >&2
            exit 1
          fi

      - name: Build
        run: npm run build

      - name: Debug - list build output
        run: |
          pwd
          ls -la
          ls -la dist || true

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        env:
          WRANGLER_LOG: debug
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=${{ env.PAGES_PROJECT }}
