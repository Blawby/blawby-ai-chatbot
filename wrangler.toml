name = "blawby-ai-chatbot"
main = "worker/index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

[ai]
binding = "AI"

[[ai.models]]
binding = "gpt-oss"
model = "@cf/openai/gpt-oss-20b"

[[ai.models]]
binding = "llava"
model = "@cf/llava-hf/llava-1.5-7b-hf"

# Fresh resources for AI chatbot
[[kv_namespaces]]
binding = "CHAT_SESSIONS"
id = "9ca96bd55b2d4455bad3fe0cda914f14"  # BLAWBY_AI_CHAT_SESSIONS
preview_id = "e7bbadb101d44a828fb3ef34528b3540"  # BLAWBY_AI_CHAT_SESSIONS_preview

[[kv_namespaces]]
binding = "USAGE_QUOTAS"
id = "ba98854ac295437dbc113871dcda2e72"       # USAGE_QUOTAS
preview_id = "a0b465f329ae4bdf8817b5c13d46d8fe"  # USAGE_QUOTAS_preview

[[d1_databases]]
binding = "DB"
database_name = "blawby-ai-chatbot"
database_id = "e4ed51fa-4787-4222-afed-bcddfefd13bf"  # blawby-ai-chatbot
migrations_dir = "worker/migrations"

# Resend API key for email notifications (set via wrangler secret put RESEND_API_KEY)

# Blawby API Configuration
[vars]
BLAWBY_API_URL = "https://staging.blawby.com"
BLAWBY_ORGANIZATION_ULID = "01jq70jnstyfzevc6423czh50e"
BETTER_AUTH_URL = "http://localhost:8787"
DOMAIN = "localhost"
# Stripe price configuration for all environments (test mode IDs)
STRIPE_PRICE_ID = "price_1SHfgbDJLzJ14cfPBGuTvcG3"
STRIPE_ANNUAL_PRICE_ID = "price_1SHfhCDJLzJ14cfPGFGQ77vQ"
# BLAWBY_API_TOKEN should be set via: wrangler secret put BLAWBY_API_TOKEN

# Lawyer Search API Configuration
LAWYER_SEARCH_API_URL = "https://search.blawby.com"
# LAWYER_SEARCH_API_KEY should be set via: wrangler secret put LAWYER_SEARCH_API_KEY

# PDF Generation Configuration
# Adobe PDF Services API for HTML-to-PDF conversion and document extraction
# Set via: wrangler secret put ADOBE_CLIENT_ID
# Set via: wrangler secret put ADOBE_CLIENT_SECRET
# Set via: wrangler secret put ADOBE_TECHNICAL_ACCOUNT_ID
# Set via: wrangler secret put ADOBE_TECHNICAL_ACCOUNT_EMAIL
# Set via: wrangler secret put ADOBE_ORGANIZATION_ID
ADOBE_IMS_BASE_URL = "https://ims-na1.adobelogin.com"
ADOBE_PDF_SERVICES_BASE_URL = "https://pdf-services.adobe.io"
ADOBE_SCOPE = "openid,AdobeID,DCAPI"

# Cloudflare AI Configuration
CLOUDFLARE_PUBLIC_URL = "https://blawby-ai-chatbot.paulchrisluke.workers.dev"
# CLOUDFLARE_API_TOKEN should be set via: wrangler secret put CLOUDFLARE_API_TOKEN
# CLOUDFLARE_ACCOUNT_ID should be set via: wrangler secret put CLOUDFLARE_ACCOUNT_ID

# PDF analysis will be implemented in a future PR

# Environment flags
NODE_ENV = "development"
DEBUG = false
VITE_DEBUG_OVERLAY = false
LOG_LEVEL = "debug"

# Feature Flags
ENABLE_STRIPE_SUBSCRIPTIONS = true
REQUIRE_EMAIL_VERIFICATION = "false"

# Authentication removed - frontend-only application

# AI Model Configuration (used in worker/agents/legal-intake/index.ts)
AI_MODEL = "@cf/openai/gpt-oss-20b"
AI_PROVIDER_DEFAULT = "workers-ai"
AI_MODEL_DEFAULT = "@cf/openai/gpt-oss-20b"
AI_MODEL_FALLBACK = "@cf/openai/gpt-oss-20b"
ENABLE_WORKERS_AI = true
ENABLE_GATEWAY_OPENAI = false

# Analysis Configuration (used in worker/routes/analyze.ts)
ANALYSIS_TIMEOUT_MS = "60000"

# Rate Limiting Configuration (referenced in README)
RATE_LIMIT_REQUESTS_PER_MINUTE = "60"
RATE_LIMIT_BURST_SIZE = "10"

# R2 bucket for file storage
[[r2_buckets]]
binding = "FILES_BUCKET"
bucket_name = "blawby-ai-files"

# Queue producers for background processing
[[queues.producers]]
queue = "doc-events"
binding = "DOC_EVENTS"

[[queues.producers]]
queue = "paralegal-tasks"
binding = "PARALEGAL_TASKS"

# Queue consumers
[[queues.consumers]]
queue = "doc-events"

[[queues.consumers]]
queue = "paralegal-tasks"

# Durable Objects migrations removed - no longer using Durable Objects

# Development environment
[env.dev]
name = "blawby-ai-chatbot-dev"
ai = { binding = "AI" }
kv_namespaces = [
  { binding = "CHAT_SESSIONS", id = "e7bbadb101d44a828fb3ef34528b3540" },
  { binding = "USAGE_QUOTAS", id = "a0b465f329ae4bdf8817b5c13d46d8fe" } # USAGE_QUOTAS_preview
]
d1_databases = [
  { binding = "DB", database_name = "blawby-ai-chatbot", database_id = "e4ed51fa-4787-4222-afed-bcddfefd13bf", migrations_dir = "worker/migrations" }
]
[[env.dev.queues.producers]]
queue = "doc-events"
binding = "DOC_EVENTS"
[[env.dev.queues.producers]]
queue = "paralegal-tasks"
binding = "PARALEGAL_TASKS"
[[env.dev.r2_buckets]]
binding = "FILES_BUCKET"
bucket_name = "blawby-ai-files"

# Development environment variables
[env.dev.vars]
NODE_ENV = "development"
LOG_LEVEL = "debug"
ENABLE_ADOBE_EXTRACT = true
ADOBE_IMS_BASE_URL = "https://ims-na1.adobelogin.com"
ADOBE_PDF_SERVICES_BASE_URL = "https://pdf-services.adobe.io"
ADOBE_SCOPE = "openid,AdobeID,DCAPI"
AI_PROVIDER_DEFAULT = "workers-ai"
AI_MODEL_DEFAULT = "@cf/openai/gpt-oss-20b"
AI_MODEL_FALLBACK = "@cf/openai/gpt-oss-20b"
ENABLE_WORKERS_AI = true
ENABLE_GATEWAY_OPENAI = false
DOMAIN = "localhost"

# Domain configuration for ai.blawby.com
[env.production]
name = "blawby-ai-chatbot"
ai = { binding = "AI" }
kv_namespaces = [
  { binding = "CHAT_SESSIONS", id = "9ca96bd55b2d4455bad3fe0cda914f14", preview_id = "e7bbadb101d44a828fb3ef34528b3540" },
  { binding = "USAGE_QUOTAS", id = "ba98854ac295437dbc113871dcda2e72", preview_id = "a0b465f329ae4bdf8817b5c13d46d8fe" }
]
d1_databases = [
  { binding = "DB", database_name = "blawby-ai-chatbot", database_id = "e4ed51fa-4787-4222-afed-bcddfefd13bf", migrations_dir = "worker/migrations" }
]
# Production environment variables
[env.production.vars]
NODE_ENV = "production"
LOG_LEVEL = "warn"
# Stripe price configuration for production (live mode IDs)
STRIPE_PRICE_ID = "price_1SI0uoDJLzJ14cfP4kmC67jR"
STRIPE_ANNUAL_PRICE_ID = "price_1SI0uoDJLzJ14cfPoXID4aj4"
ENABLE_ADOBE_EXTRACT = true
ADOBE_IMS_BASE_URL = "https://ims-na1.adobelogin.com"
ADOBE_PDF_SERVICES_BASE_URL = "https://pdf-services.adobe.io"
ADOBE_SCOPE = "openid,AdobeID,DCAPI"
AI_PROVIDER_DEFAULT = "workers-ai"
AI_MODEL_DEFAULT = "@cf/openai/gpt-oss-20b"
AI_MODEL_FALLBACK = "@cf/openai/gpt-oss-20b"
ENABLE_WORKERS_AI = true
ENABLE_GATEWAY_OPENAI = false
BETTER_AUTH_URL = "https://ai.blawby.com"
DOMAIN = "ai.blawby.com"
ENABLE_STRIPE_SUBSCRIPTIONS = true
REQUIRE_EMAIL_VERIFICATION = "false"

# Updated to use modern nested producers syntax
[[env.production.queues.producers]]
queue = "doc-events"
binding = "DOC_EVENTS"
[[env.production.queues.producers]]
queue = "paralegal-tasks"
binding = "PARALEGAL_TASKS"
[[env.production.r2_buckets]]
binding = "FILES_BUCKET"
bucket_name = "blawby-ai-files"

[[env.production.routes]]
pattern = "ai.blawby.com/api/*"
zone_name = "blawby.com"

[observability]
[observability.logs]
enabled = false
head_sampling_rate = 1
invocation_logs = true